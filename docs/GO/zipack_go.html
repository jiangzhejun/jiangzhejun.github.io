<html>

<head>
  <link rel='stylesheet' href='../../inc/code.css'>
  <link rel='stylesheet' href='../../inc/default.css'>
  <meta charset="utf-8">
  <title>zipack.go</title>
</head>

<body>
  <pre class='code'><span class='wbk_package_keyword'>package</span> zipack

<span class='wbk_package_keyword'>import</span> (
  "archive/zip"
  "io"
  "os"
  "path"
  "path/filepath"
  "strings"
)

<span class='wbk_difine_keyword'>func</span> Get(dest string, src string) error {
  zr, err := zip.OpenReader(src)
  <span class='wbk_process_control'>if</span> err != nil {
    <span class='wbk_process_control'>return</span> err
  }
  <span class='wbk_process_control'>defer</span> zr.Close()

  <span class='wbk_process_control'>for</span> _, f := <span class='wbk_operator'>range</span> zr.File {
    path := filepath.Join(dest, f.Name)
    <span class='wbk_process_control'>if</span> f.FileInfo().IsDir() {
      os.MkdirAll(path, os.ModePerm)
    } <span class='wbk_process_control'>else</span> {
      <span class='wbk_process_control'>if</span> err = os.MkdirAll(filepath.Dir(path), os.ModePerm); err != nil {
        <span class='wbk_process_control'>return</span> err
      }

      fout, err := os.OpenFile(path, os.O_CREATE|os.O_TRUNC|os.O_WRONLY, f.Mode())
      <span class='wbk_process_control'>if</span> err != nil {
        <span class='wbk_process_control'>return</span> err
      }
      <span class='wbk_process_control'>defer</span> fout.Close()

      fin, err := f.Open()
      <span class='wbk_process_control'>if</span> err != nil {
        <span class='wbk_process_control'>return</span> err
      }
      <span class='wbk_process_control'>defer</span> fin.Close()

      _, err = io.Copy(fout, fin)
      <span class='wbk_process_control'>if</span> err != nil {
        <span class='wbk_process_control'>return</span> err
      }
    }
  }

  <span class='wbk_process_control'>return</span> nil
}

<span class='wbk_difine_keyword'>func</span> Set(dest string, srcs ... string) error {
  f, err := os.Create(dest)
  <span class='wbk_process_control'>if</span> err != nil {
    <span class='wbk_process_control'>return</span> err
  }
  <span class='wbk_process_control'>defer</span> f.Close()

  zw := zip.NewWriter(f)
  <span class='wbk_process_control'>defer</span> zw.Close()

  <span class='wbk_process_control'>for</span> _, src := <span class='wbk_operator'>range</span> srcs {
    filepath.Walk(workDirectory(src), <span class='wbk_difine_keyword'>func</span>(path string, info os.FileInfo, err error) error {
      <span class='wbk_process_control'>if</span> err != nil || strings.Contains(path, ".nozip") {
        <span class='wbk_process_control'>return</span> err
      }

      h, err := zip.FileInfoHeader(info)
      <span class='wbk_process_control'>if</span> err != nil {
        <span class='wbk_process_control'>return</span> err
      }

      h.Name = strings.TrimPrefix(path, filepath.Dir(src) + "/")
      <span class='wbk_process_control'>if</span> info.IsDir() {
        h.Name += "/"
      } <span class='wbk_process_control'>else</span> {
        h.Method = zip.Deflate
      }

      fout, err := zw.CreateHeader(h)
      <span class='wbk_process_control'>if</span> err != nil {
        <span class='wbk_process_control'>return</span> err
      }

      <span class='wbk_process_control'>if</span> ! info.IsDir() {
        fin, err := os.Open(path)
        <span class='wbk_process_control'>if</span> err != nil {
          <span class='wbk_process_control'>return</span> err
        }
        <span class='wbk_process_control'>defer</span> fin.Close()

        _, err = io.Copy(fout, fin)
        <span class='wbk_process_control'>if</span> err != nil {
          <span class='wbk_process_control'>return</span> err
        }
      }

      <span class='wbk_process_control'>return</span> nil
    })
  }

  <span class='wbk_process_control'>return</span> nil
}

<span class='wbk_difine_keyword'>func</span> workDirectory(src string) string {
  dir, err := filepath.Abs(filepath.Dir(src))
  <span class='wbk_process_control'>if</span> err != nil {
    <span class='wbk_process_control'>return</span> src
  }

  err = os.Chdir(dir)
  <span class='wbk_process_control'>return</span> path.Base(filepath.ToSlash(src))
}</pre>
</body>

</html>